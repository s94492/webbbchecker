# 修復事件時間線的時間準確性問題

## 發布日期
2025-09-17 14:54

## 版本
v1.0.20-patch

## 問題描述
- 異常事件時間線中，「服務異常」和「服務恢復」的時間順序錯亂
- 原因：事件檢測使用聚合後的資料，聚合過程導致時間不準確
  - 聚合使用區間第一個資料點的時間
  - 但健康狀態使用整個區間的保守判斷（只要有一個不健康就標記為不健康）
  - 造成時間點與實際狀態變化不符

## 修復內容

### 1. 新增原始資料查詢方法
在 `backend/src/services/InfluxService.js` 新增 `getRawMetrics` 方法：
- 取得原始資料（不進行聚合）
- 專門用於事件檢測，確保時間準確性

### 2. 修改事件檢測邏輯
修改 `backend/src/routes/metrics.js`：
- 事件檢測改用 `getRawMetrics` 取得原始資料
- 避免聚合造成的時間錯亂
- 確保事件時間點與實際狀態變化一致

## 技術細節

### 之前的問題
```
聚合區間: 11:30 - 12:00
- 11:30 健康 (作為聚合後的時間點)
- 11:45 健康
- 11:58 不健康 (導致整個區間被標記為不健康)
結果: 11:30 顯示為不健康（實際上 11:30 是健康的）
```

### 修復後
```
使用原始資料:
- 11:30 健康
- 11:45 健康
- 11:58 不健康 (準確記錄狀態變化時間)
結果: 11:58 顯示為服務異常（時間準確）
```

## 測試結果
- ✅ 事件時間順序正確
- ✅ 異常和恢復時間對應合理
- ✅ 原始資料保證時間準確性
- ✅ 聚合資料仍用於圖表顯示（性能優化）